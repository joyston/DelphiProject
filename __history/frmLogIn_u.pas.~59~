unit frmLogIn_u;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, frmDiary_u, frmDbModule_u,
  Vcl.Mask;

const
  InputBoxMessage = WM_USER + 200;

type
  TfrmLogIn = class(TForm)
    edtUsername: TEdit;
    btnLogin: TButton;
    lblUsername: TLabel;
    lblPassword: TLabel;
    edtPassword: TMaskEdit;
    procedure btnLoginClick(Sender: TObject);
  private
    { Private declarations }
    procedure InputBoxSetPasswordChar(var Msg: TMessage); message InputBoxMessage;
  public
    { Public declarations }
    //puserID : ^Integer;
    userID : Integer;
    userInstance : TDbFunctions;
  end;

var
  frmLogIn: TfrmLogIn;


implementation
//puserID := @userID;

{$R *.dfm}

procedure TfrmLogIn.InputBoxSetPasswordChar(var Msg: TMessage);
var
  hInputForm, hEdit, hButton: HWND;
begin
  hInputForm := Screen.Forms[0].Handle;
  if (hInputForm <> 0) then
  begin
    hEdit := FindWindowEx(hInputForm, 0, 'TEdit', nil);
    {
      // Change button text:
      hButton := FindWindowEx(hInputForm, 0, 'TButton', nil);
      SendMessage(hButton, WM_SETTEXT, 0, Integer(PChar('Cancel')));
    }
    SendMessage(hEdit, EM_SETPASSWORDCHAR, Ord('*'), 0);
  end;
end;

procedure TfrmLogIn.btnLoginClick(Sender: TObject);
//var DB : Tdbmodule;
//var userInstance : TDbFunctions;
begin
  userInstance := TDbFunctions.Create;
  try
    try
      if (edtUsername.Text <> '') AND (edtPassword.Text <> '') then
      begin
         //puserID := @userID;
         //Code to check credentials
         //dbmodule.FDConnection1.Connected := true;
         //dbmodule.FDQuery1.Active := true;

         if not userInstance.ConnectToDb() then
          Exit;

         userID := userInstance.GetUserId(edtUsername.Text, edtPassword.Text);

         if userID <> 0 then
         begin
           frmDiary.Show;
         end
         else
         begin
          ShowMessage('Please enter valid Username and Password');
         end;
      end
      else
      begin
        if (edtUsername.Text = '') then
          ShowMessage('Please enter your Username')
        else
          ShowMessage('Please enter your Password');
      end;
    Except
      on E : Exception do
      begin
        ShowMessage(E.Message);
      end;
    end;
  finally
    FreeAndNil(userInstance);
  end;
end;

end.
